
---
# [Wireshark Malware Traffic Analysis - OriginLogger (Agent Tesla)](https://www.youtube.com/watch?v=gcXA1nwvzjM)

---

**Credits**

- This project was inspired by:
	- [Chris Greer](https://www.youtube.com/@ChrisGreer)

---

- In this lab we will be learning about:
	- **[OriginLogger](https://unit42.paloaltonetworks.com/originlogger/)**: On March 4, 2019, one of the most well-known keyloggers used by criminals, called Agent Tesla, closed up shop due to legal troubles. In the announcement message posted on the Agent Tesla Discord server, the keylogger’s developers suggested people switch over to a new keylogger: “If you want to see a powerful software like Agent Tesla, we would like to suggest you OriginLogger. OriginLogger is an AT-based software and has all the features.” OriginLogger is a variant of Agent Tesla. As such, the majority of tools and detections for Agent Tesla will still trigger on OriginLogger samples.

- **Key Skills/Tools:** Wireshark, packet capture analysis, pcap forensics, malware traffic patterns

---

- 🦈 **What is Wireshark?**
	- **Wireshark** is an open-source network protocol analyzer that lets you capture and interactively browse network traffic. It allows analysts to view data packets flowing in and out of a system in real time or from saved PCAP files.

-  🛡️ **Wireshark Use Cases for SOC Analysts**
	- 🔍 **Incident Investigation:** Analyze malicious traffic patterns (e.g., C2 communication, lateral movement)
	- 🕵️ **Malware Analysis:** Extract indicators like domains, IPs, and payloads from suspicious network behavior
	- 🚨 **Threat Hunting:** Detect anomalies like DNS tunneling, beaconing, or unauthorized FTP/SSH usage
	- 🛠️ **Protocol Troubleshooting:** Identify service failures, misconfigurations, or latency issues
 
- 🐛**What it Malware-Traffic-Analysis**
	- **Traffic** is a critical aspect of malware. When malware tries to steal data or receive instructions from an attacker, it needs to connect to an external network, which creates malicious traffic that can be analyzed using tools like **Wireshark** during malware analysis. However, to effectively understand and analyze malware traffic, it's essential to learn and practice using these tools. **`Malware-traffic-analysis.net`** is a valuable resource that offers detailed information on ==real-world malware situations==, as well as exercises to sharpen our malware analysis and traffic analysis skills. These exercises are designed to be carried out using Wireshark, a widely used industry-standard tool for network and malware analysis.
	- **Malware**, short for malicious software, is designed to infiltrate, damage, or exfiltrate data from computer systems without the user's consent. Analyzing malware traffic helps to detect and respond to security threats, identify patterns in attacks, and strengthen network defenses.
	- The first step to analyzing **malware traffic** involves packet analysis. **Packets** are small chunks of data that computers send across networks. By capturing these packets using tools like Wireshark, a network analyst can inspect each piece of data to identify suspicious patterns. The pcap files available on Malware-Traffic-Analysis.net are an invaluable resource for this, as they provide real-world examples of malware traffic for analysis.

---

## Getting Started

### Download the PCAP

- Download the pcap needed for this lab from **[here](https://github.com/pan-unit42/Wireshark-quizzes/blob/main/2023-01-Unit42-Wireshark-quiz.pcap.zip)**.
- ![image](https://github.com/user-attachments/assets/021c7279-3471-4507-86c3-8e57657d2df0)
- Extract the pcap from the zip file with the password `infected`.
- ![image](https://github.com/user-attachments/assets/deacc8cc-54d7-450c-a8a6-4796888f12d1)
- I'll rename the pcap to `OriginLogger-AgentTesla` for simplicity sake.
- ![image](https://github.com/user-attachments/assets/d9a153cd-efc7-48c2-b417-16f65a0a76f3)

### Open Wireshark

- Open Wireshark as Administrator.
- ![image](https://github.com/user-attachments/assets/945e3acf-7c56-48e6-9e1d-8cc71e5368c2)
- When open, click "File", then "Open".
- ![image](https://github.com/user-attachments/assets/5f035d44-c79c-436a-b669-2b78557aebfa)
- Then select `OriginLogger-AgentTesla.pcap` and click "Open".
- ![image](https://github.com/user-attachments/assets/2a25ca52-9f52-4560-a6bd-00295d16986b)

### Palo Alto Unit 42

- We will be answering questions from [Palo Alto Network's Unit 42](https://unit42.paloaltonetworks.com/january-wireshark-quiz/).
- ![image](https://github.com/user-attachments/assets/36335a45-0628-4ad3-bd0f-f980b4f6725b)

> 💡 **What is Unit 42?**
> - Unit 42 is the Palo Alto Networks threat intelligence and security consulting team. They are a group of cybersecurity researchers and industry experts who use data collected by the company's security platform to discover new cyber threats, such as new forms of malware and malicious actors operating across the world. The group runs a popular blog where they post technical reports analyzing active threats and adversaries. Multiple Unit 42 researchers have been named in the MSRC Top 100, Microsoft's annual ranking of top 100 security researchers.
>
> - According to the FBI, Palo Alto Networks Unit 42 has helped solve multiple cybercrime cases, such as the Mirai Botnet and Clickfraud Botnet cases, the LuminosityLink RAT case, and assisted with "Operation Wire-Wire".
>
> - The name "**Unit 42**" was chosen by Palo Alto Networks to honor Douglas Adams' "**The Hitchhiker's Guide to the Galaxy**". The number "42" serves as a nod to the book, which suggests that the answer to the *ultimate question* is 42. This choice reflects the company's commitment to providing intelligence-driven solutions in cybersecurity.

---

## Answering Questions

- Now that the pcap is open, we can begin answering questions.
- ![image](https://github.com/user-attachments/assets/02bcbfa4-90c8-4711-b8d5-5e69d2c3fe1f)

### **When did the malicious traffic start in UTC?**

- The first step we need to take is to make sure your Wireshark time is set from the default of `Seconds Since First Captured Packet` to `UTC Date and Time of Day...`
- ![image](https://github.com/user-attachments/assets/6cc989d4-0cd6-47da-882b-fc2c7a2cff95)
- Now we that we can see the time in UTC format, we can confidently say that **the malicious traffic began at this timestamp**: **🕒 2023-01-05 22:51:00.243743 UTC**
- ![image](https://github.com/user-attachments/assets/791b247e-19b2-473a-a520-2c3247929d00)


> 💡 Reasoning:
> 
> - This is **Packet 5**, where the internal host `192.168.1.27` initiates a **TCP connection to 45.56.99.101** on port 80, immediately after resolving `savory.com.bd` in DNS (Packet 3 & 4). This domain and IP are highly likely to be part of the **OriginLogger C2 infrastructure** or hosting a dropper/payload.
> 	
>   - **Packet 3–4 (DNS):** The host looks up `savory.com.bd`, which resolves to `45.56.99.101`.
>   - **Packet 5 (TCP SYN):** Marks the **first direct contact** to the suspicious external IP.
> 		
> - Although the earlier ARP and DNS packets are legitimate network activity, **Packet 5 is the start of outbound communication to a known malicious domain**, indicating the **initial stage of compromise or beaconing**.

### **What is the victim’s IP address?**

- Glancing at the "Source" column, we can see `192.168.1.27` is the victim's IP address.
- ![image](https://github.com/user-attachments/assets/c0842b52-306d-4d2c-b04b-308f145873e6)
- Something else we can do is click "Statistics" and select "Conversations". Once there, click to the "IPv4" tab.
- ![image](https://github.com/user-attachments/assets/c7826607-dfe5-4fa4-b142-94efad9f5d70)
- Here on the "IPv4" tab, You'll see a table showing all IP-to-IP communications. Look for the internal IP that appears **consistently as a source** when talking to **external IPs (e.g., 45.56.99.101)**. We can see `192.168.1.27` is repeatedly initiating connections to external IPs. This means that it is very likely that the client side is infected and generating all of this traffic. 💡 The Conversations feature gives you a **summary view of traffic volume**, **direction**, and **endpoints**, making it ideal for spotting who the internal talker is in suspicious flows.
- ![image](https://github.com/user-attachments/assets/eaf95d1e-9109-499c-a13f-0a55f8d3dda5)

### **What is the victim’s MAC address?**

- Stay in "Conversations". Click on the "Ethernet" tab. Notice `bc:ea:fa:22:74:fb` is talking the most.
- ![image](https://github.com/user-attachments/assets/3334ff93-80c8-419e-9f69-1fdfc51435f3)
- On the left hand side, if you check the checkbox for "Name resolution", we can see that this is a Hewlett Packard MAC address.
- ![image](https://github.com/user-attachments/assets/191d8156-3a36-41a7-b6c4-90206f242800)
- What we can also do to confirm is Identify the internal IP → MAC mapping from earlier packet analysis. From the earlier traffic, IP `192.168.1.27` was identified as the **victim**! Taking a look in the ARP reply (Packet 2) we see a familiar MAC address: `192.168.1.27 is at bc:ea:fa:22:74:fb`
- ![image](https://github.com/user-attachments/assets/7dfd3f9c-ea99-4703-b562-c8a24ced39e9)
- So we already know the MAC for the victim IP. Looking at the table:

| Address A             | Address B         | Packets | Bytes  |
| --------------------- | ----------------- | ------- | ------ |
| **bc:ea:fa:22:74:fb** | 00:14:78:37:9b:f6 | 1043    | 901549 |
| **bc:ea:fa:22:74:fb** | 01:00:5e:7f:ff:fa | 3       | 537    |
| **bc:ea:fa:22:74:fb** | ff:ff:ff:ff:ff:ff | 1       | 258    |

- `bc:ea:fa:22:74:fb` is **sending and receiving the most data**, which aligns with our victim making HTTP requests, DNS lookups, etc.

### **What is the victim’s Windows host name?**

- To find the Windows host name, we will use this Wireshark display filter: `frame matches "desktop"`. This searches the **entire packet payloads** (not just fields) for any string that matches "desktop", which is often part of Windows default hostnames like `DESKTOP-XXXX`, `DESKTOP-WIN11PC` , etc.
- ![image](https://github.com/user-attachments/assets/ea83ce42-8743-4866-8252-dbd128302430)
- Now we know the **Victim's Windows hostname:** `DESKTOP-WIN11PC`. Let's explore the few packets that came from our display filter:

> 💡 **Packet 647 – SMTP EHLO Command**
> 	- `C: EHLO DESKTOP-WIN11PC`
> 		- This packet shows the **victim initiating an SMTP session** (Simple Mail Transfer Protocol).
> 		The `EHLO` command is used to identify the **client's hostname** to the mail server.
> 		This is a **clear and reliable indicator** of the local hostname: `DESKTOP-WIN11PC`.
>
> 💡 **Packet 649 – SMTP Server Response**
> 	- `S: 250-bh-41.webhostbox.net Hello DESKTOP-WIN11PC [...]`
> 		- The server acknowledges the client’s hostname.
> 		This **echoes and confirms** that the victim presented itself as `DESKTOP-WIN11PC`.
>
> 💡 **What is the `EHLO` Command Doing?**
> 	- `EHLO` (Extended Hello) is used during the initial SMTP handshake.
> 	  - It’s required by the server to **log** and sometimes **validate** the client's identity.
> 	Malware that uses SMTP for data exfiltration (like OriginLogger and Agent Tesla) often leverages this, unintentionally revealing the hostname.
>
> 💡 **Other Supporting Packet – NetBIOS Broadcast (Packet 704):**
> 	- `Domain/Workgroup Announcement WORKGROUP, NT Workstation, Domain Enum`
> 		- This packet shows a **NetBIOS Name Service (NBNS)** announcement by the victim.
> 		Though it doesn’t explicitly name the machine in this packet, such broadcasts often **announce hostnames**, so examining NBNS or LLMNR traffic could provide additional confirmation.
> 		In some cases, Wireshark may resolve this automatically if `Name Resolution` is turned on.
>
> ⭐ **Practical Tip – Why This Is Valuable**
> 	- Malware using SMTP, FTP, or HTTP **often embeds hostnames in protocol headers** (like `EHLO`, `User-Agent`, etc.).
> 	By tracking this, incident responders can **pinpoint the infected machine by hostname**, even in DHCP environments where IPs change frequently.

### **What is the victim’s Windows user account name?**

- To find out the user account name, right click on packet number 647, click "Follow", then "TCP Stream".
- ![image](https://github.com/user-attachments/assets/d821df02-3a77-4f5a-a5cb-3b0af4fc37f2)
- This will show us the stream data. We can gather the answers to the rest of our questions from this data alone!
- ![image](https://github.com/user-attachments/assets/9475166c-e579-4aed-b82e-9709536d3de4)
- For the the victim’s Windows user account name, look at the message body: `User Name: windows11user`. This is the local Windows account name extracted by the malware and sent via SMTP.
- ![image](https://github.com/user-attachments/assets/c5a45716-4d27-4d74-bc5e-1e18c7ab7cf4)

### **How much RAM does the victim’s host have?**

- **Answer:** `32165.83 MB` (approximately **32 GB**). From the message body: `RAM: 32165.83 MB`.
- ![image](https://github.com/user-attachments/assets/14ce371b-c264-4f07-8ab6-4e64152a9cb1)

### **What type of CPU is used by the victim’s host?**

- **Answer:** `Intel(R) Core(TM) i5-13600K CPU @ 5.10GHz`. From the message body: `CPU: Intel(R) Core(TM) i5-13600K CPU @ 5.10GHz`
- ![image](https://github.com/user-attachments/assets/2b4e813a-68ea-45e9-99ad-4518c543b009)

### **What is the public IP address of the victim’s host?**

- Scroll up to the top. **Answer:** `173.66.46.112`. It actually appears twice:
	- In the server's EHLO response (from our display filter) : `250-bh-41.webhostbox.net Hello DESKTOP-WIN11PC [173.66.46.112]`
	- ![image](https://github.com/user-attachments/assets/c3b954ac-3fb1-47a5-a177-5f37313c94e1)
	- In the message body: `IP Address: 173.66.46.112`
	- ![image](https://github.com/user-attachments/assets/defb43c8-4107-4d5f-a696-636f80551951)
- This confirms it as the public IP the victim was using during exfiltration.

### **What type of account login data was stolen by the malware?**

- **Answer:** Email, webmail, and online service credentials including usernames and passwords for:
	- **Thunderbird IMAP/SMTP**
	- **Webmail (webmail.windows11users.com)**
	- **Coca-Cola login portal**
	- **LinkedIn**
	- **Amazon**
	- **Target**
	- **New York Times**

> 💡 **Explanation:**  
>	- The malware exfiltrated a long list of account credentials via SMTP. Each section follows this pattern:
>		- URL:...
>		- Username:...
>		- Password:...
>		- Application:...
>	- The presence of **multiple well-known URLs**, a mix of **email protocols**, and **browser-based logins** shows the malware likely had **credential-stealing capabilities** (likely from browsers and mail clients like Thunderbird).
>
> 💡 **Extra Tip**
>	- This pattern of behavior — sending host info and credentials via SMTP — is very characteristic of **Agent Tesla** (predecessor), **OriginLogger** (what we are analyzing), or **RedLine Stealer**. They often:
>		- Grab system specs
>		- Dump browser/mail app credentials
>		- Send it all via SMTP or Telegram

## 🔎 **Extra Analysis - Decoding Base64 Logins**

### Username

- If you have completed a few capture the flags (CTFs) or are familiar with cryptography, you will recognize Base64. It just so happens that we have some login credentials that are Base64 encoded, and can be decoded COMPLETELY within Wireshark! Let's begin now. Make sure you are in the display filter for our TCP stream that we followed "`tcp.stream eq 2`". Then click on packet 650. In the details section, notice the Username.
- ![image](https://github.com/user-attachments/assets/643c3024-d702-4ec7-b879-70266a5b4c53)
- This is not the actual username, it was sent encoded. We can right click on the UN and click "Show Packet Bytes..."
- ![image](https://github.com/user-attachments/assets/5be64bdf-02eb-46b9-beb0-5540a07c244f)
- In the pop up window, we have the encoded username. To decode it, from "Decode as", select `Base64`.
- ![image](https://github.com/user-attachments/assets/16f2ce27-63b4-454d-914f-ec86f49e75fd)
- It will automatically reveal the username: `marketing@transgear.in`.
- ![image](https://github.com/user-attachments/assets/fe3f4e91-add9-48ca-adb3-e5089f841128)

### Password

- Now that we have the username information, let's retrieve the password. Click "Close". Look down a few packets to number 653. It says shows the Base64 encoded password here.
- ![image](https://github.com/user-attachments/assets/b9f7ff0e-53ee-4b57-8149-1d5068b6c872)
- Repeat the steps to show the packet bytes and decode. Before:
- ![image](https://github.com/user-attachments/assets/56d09899-471d-4312-a8e8-c211a968b935)
- After:
- ![image](https://github.com/user-attachments/assets/c7854b31-407d-479f-be20-789db8ddd150)
- Now we have everything we need to authenticate into the SMTP server if we wanted to have access. This will not work with all UN & PW are Base64 encoded, but when we're dealing with a protocol like SMTP that's exchanging that with Base64, we can use the show packet bytes feature to decode it from Base64 to ASCII right from within Wireshark! Hope you enjoyed the lab!

---
